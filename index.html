<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Diagnostics</title>
  <link rel="stylesheet" href="style.css" />
  
</head>
<body>
  <h1>üîç TAM Dashboard Diagnostics</h1>
  <p class="info">This tool will help identify why your dashboard shows "failed to fetch"</p>

  <button onclick="runAllTests()">Run All Tests</button>
  <button onclick="clearResults()">Clear Results</button>

  <div id="results"></div>

  <script>
    const API_BASE = 'https://api.cctamcc.site'; // Change this to your server URL
    let results = document.getElementById('results');

    function addResult(title, status, message, data = null) {
      const div = document.createElement('div');
      div.className = `test ${status}`;
      div.innerHTML = `
        <h3>${title}</h3>
        <p>${message}</p>
        ${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ''}
      `;
      results.appendChild(div);
    }

    function clearResults() {
      results.innerHTML = '';
    }

    async function test1_ServerReachable() {
      addResult('Test 1: Server Reachable', 'warn', 'Testing server connection...');
      
      try {
        const response = await fetch(`${API_BASE}/`, {
          method: 'GET'
        });
        
        if (response.ok) {
          const data = await response.json();
          addResult('Test 1: Server Reachable', 'pass', 
            `‚úÖ Server is online and responding`, data);
        } else {
          addResult('Test 1: Server Reachable', 'fail', 
            `‚ùå Server returned status ${response.status}`);
        }
      } catch (err) {
        addResult('Test 1: Server Reachable', 'fail', 
          `‚ùå Cannot reach server: ${err.message}`, { error: err.message });
      }
    }

    async function test2_CORSHeaders() {
      addResult('Test 2: CORS Configuration', 'warn', 'Checking CORS headers...');
      
      try {
        const response = await fetch(`${API_BASE}/`, {
          method: 'GET',
          credentials: 'include'
        });
        
        const corsHeader = response.headers.get('access-control-allow-credentials');
        
        if (corsHeader === 'true') {
          addResult('Test 2: CORS Configuration', 'pass', 
            '‚úÖ CORS is properly configured for credentials');
        } else {
          addResult('Test 2: CORS Configuration', 'fail', 
            '‚ùå CORS not allowing credentials. Check server CORS config.', 
            { 
              current_origin: window.location.origin,
              cors_credentials: corsHeader 
            });
        }
      } catch (err) {
        addResult('Test 2: CORS Configuration', 'fail', 
          `‚ùå CORS test failed: ${err.message}`);
      }
    }

    async function test3_CookiePresent() {
      addResult('Test 3: Authentication Cookie', 'warn', 'Checking for access_token cookie...');
      
      const cookies = document.cookie;
      const hasAccessToken = cookies.includes('access_token');
      const hasRefreshToken = cookies.includes('refresh_token');
      
      if (hasAccessToken) {
        addResult('Test 3: Authentication Cookie', 'pass', 
          '‚úÖ Access token cookie found. You are logged in.', 
          { cookies: cookies.split(';').map(c => c.trim()) });
      } else if (hasRefreshToken) {
        addResult('Test 3: Authentication Cookie', 'warn', 
          '‚ö†Ô∏è Refresh token found but no access token. Try refreshing the page.', 
          { cookies: cookies.split(';').map(c => c.trim()) });
      } else {
        addResult('Test 3: Authentication Cookie', 'fail', 
          '‚ùå No authentication cookies found. You need to log in first.', 
          { 
            message: 'Please log in at your main app first, then return to admin dashboard',
            current_cookies: cookies || 'none'
          });
      }
    }

    async function test4_AdminStatsEndpoint() {
      addResult('Test 4: Admin Stats Endpoint', 'warn', 'Testing /admin/stats endpoint...');
      
      try {
        const response = await fetch(`${API_BASE}/admin/stats`, {
          method: 'GET',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.status === 401) {
          addResult('Test 4: Admin Stats Endpoint', 'fail', 
            '‚ùå Unauthenticated (401). You need to log in first.');
          return;
        }
        
        if (response.status === 403) {
          addResult('Test 4: Admin Stats Endpoint', 'fail', 
            '‚ùå Forbidden (403). Your account is not an admin. Run: UPDATE users SET role=\'admin\' WHERE email=\'your@email.com\';');
          return;
        }
        
        if (response.ok) {
          const data = await response.json();
          addResult('Test 4: Admin Stats Endpoint', 'pass', 
            '‚úÖ Admin endpoint working! You have admin access.', data);
        } else {
          addResult('Test 4: Admin Stats Endpoint', 'fail', 
            `‚ùå Unexpected status: ${response.status}`);
        }
      } catch (err) {
        addResult('Test 4: Admin Stats Endpoint', 'fail', 
          `‚ùå Request failed: ${err.message}`, { error: err.message });
      }
    }

    async function test5_AdminAuditsEndpoint() {
      addResult('Test 5: Admin Audits Endpoint', 'warn', 'Testing /admin/audits endpoint...');
      
      try {
        const response = await fetch(`${API_BASE}/admin/audits`, {
          method: 'GET',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          addResult('Test 5: Admin Audits Endpoint', 'pass', 
            `‚úÖ Audits endpoint working! Found ${data.length} audits.`, 
            data.slice(0, 2)); // Show first 2
        } else {
          addResult('Test 5: Admin Audits Endpoint', 'fail', 
            `‚ùå Status: ${response.status}. ${response.status === 403 ? 'Not admin' : 'Check server logs'}`);
        }
      } catch (err) {
        addResult('Test 5: Admin Audits Endpoint', 'fail', 
          `‚ùå Request failed: ${err.message}`);
      }
    }

    async function test6_DatabaseTables() {
      addResult('Test 6: Database Schema Check', 'warn', 
        'Checking if activity_logs table exists by trying to fetch activities...');
      
      try {
        const response = await fetch(`${API_BASE}/admin/activities?limit=1`, {
          method: 'GET',
          credentials: 'include'
        });
        
        if (response.ok) {
          addResult('Test 6: Database Schema Check', 'pass', 
            '‚úÖ Database schema is correct. activity_logs table exists.');
        } else if (response.status === 500) {
          addResult('Test 6: Database Schema Check', 'fail', 
            '‚ùå Database error. Did you run database-migration.sql?', 
            { action: 'Run: psql $DATABASE_URL -f database-migration.sql' });
        } else {
          addResult('Test 6: Database Schema Check', 'warn', 
            `‚ö†Ô∏è Status ${response.status}. May be auth issue, not DB.`);
        }
      } catch (err) {
        addResult('Test 6: Database Schema Check', 'fail', 
          `‚ùå Cannot test: ${err.message}`);
      }
    }

    async function runAllTests() {
      clearResults();
      
      addResult('Starting Diagnostics', 'warn', 
        `Testing connection to: ${API_BASE}`);
      
      await test1_ServerReachable();
      await new Promise(r => setTimeout(r, 500));
      
      await test2_CORSHeaders();
      await new Promise(r => setTimeout(r, 500));
      
      await test3_CookiePresent();
      await new Promise(r => setTimeout(r, 500));
      
      await test4_AdminStatsEndpoint();
      await new Promise(r => setTimeout(r, 500));
      
      await test5_AdminAuditsEndpoint();
      await new Promise(r => setTimeout(r, 500));
      
      await test6_DatabaseTables();
      
      addResult('Diagnostics Complete', 'warn', 
        'Check results above. Common fixes below:', {
          'Not logged in': 'Go to your main app and log in first',
          'Not admin': 'Run SQL: UPDATE users SET role=\'admin\' WHERE email=\'your@email.com\'',
          'No database tables': 'Run: psql $DATABASE_URL -f database-migration.sql',
          'CORS errors': 'Add your domain to CORS allowed origins in server.js',
          'Wrong API URL': `Change API_BASE in script.js to your actual server URL`
        });
    }

    // Auto-run on load
    window.addEventListener('DOMContentLoaded', () => {
      addResult('System Info', 'warn', 'Current environment details', {
        'Current URL': window.location.href,
        'API Base': API_BASE,
        'Browser': navigator.userAgent,
        'Cookies Enabled': navigator.cookieEnabled
      });
    });
  </script>

  <script src="script.js"></script>
</body>
</html>
